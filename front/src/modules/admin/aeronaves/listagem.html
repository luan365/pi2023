<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="../../../assets/css/listagem.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <link rel="icon" href="../../../assets/images/icone.png">
  <title>Aeronaves</title>
  <script lang="javascript">



    function anoValido() {
      let resultado = false;
      // obter o texto preenchido no campo anoFab
      var strAno = document.getElementById("anoFab").value;
      const ano = parseInt(strAno);
      console.log("Ano aeronave: " + ano.toString());
      if (ano >= 1990 && ano <= 2026) {
        resultado = true;
      }
      return resultado;
    }

    // verifica se o campo total de assentos é numerico e válido
    function totalAssentosValido() {
      let resultado = false;
      const strAssentos = document.getElementById("totalAssentos").value;
      const assentos = parseInt(strAssentos);
      if (assentos > 0) {
        resultado = true;
      }
      return resultado;
    }

    // funcao que verifica se selecionou ou não o fabricante.
    function selecionouFabricante() {
      let resultado = false;
      var listaFabricantes = document.getElementById("comboFabricantes");
      var valorSelecionado = listaFabricantes.value;
      // se quiséssemos obter o TEXTO selecionado. 
      // var text = listaFabricantes.options[listaFabricantes.selectedIndex].text;
      if (valorSelecionado !== "0") {
        resultado = true;
      }
      return resultado;
    }

    // funcao que verifica se preencheu o modelo.
    function preencheuModelo() {
      let resultado = false;
      const modeloInformado = document.getElementById("modelo").value;
      if (modeloInformado.length > 0) {
        resultado = true;
      }
      return resultado;
    }

    // funcao para verificar se preencheu o registro de referencia. 
    function preencheuRegistro() {
      let resultado = false;
      const registroReferencia = document.getElementById("referencia").value;
      if (registroReferencia.length > 0) {
        resultado = true;
      }
      return resultado;
    }


    function alterarAeronave(codigo) {
      document.getElementById("edit-aeronave").style.display = "block";

      // Exibição dos campos
      document.getElementById("exibicao_fabricante").style.display = "block";
      document.getElementById("exibicao_modelo").style.display = "block";
      document.getElementById("exibicao_anoFab").style.display = "block";
      document.getElementById("exibicao_referencia").style.display = "block";
      document.getElementById("exibicao_totalAssentos").style.display = "block";

      // Edição dos campos
      document.getElementById("editCodigoAeronave").value = codigo;
      document.getElementById("editFabricante").value = document.getElementById("exibicao_fabricante").innerText;
      document.getElementById("editModelo").value = document.getElementById("exibicao_modelo").innerText;
      document.getElementById("editAnoFab").value = document.getElementById("exibicao_anoFab").innerText;
      document.getElementById("editReferencia").value = document.getElementById("exibicao_referencia").innerText;
      document.getElementById("editTotalAssentos").value = document.getElementById("exibicao_totalAssentos").innerText;

      // Oculta campos de exibição
      document.getElementById("exibicao_fabricante").style.display = "none";
      document.getElementById("exibicao_modelo").style.display = "none";
      document.getElementById("exibicao_anoFab").style.display = "none";
      document.getElementById("exibicao_referencia").style.display = "none";
      document.getElementById("exibicao_totalAssentos").style.display = "none";

      if (!selecionouFabricante()) {
        showStatusMessage("Selecione o fabricante...", true);
        return;
      }

      if (!preencheuModelo()) {
        showStatusMessage("Preencha o modelo...", true);
        return;
      }

      if (!preencheuRegistro()) {
        showStatusMessage("Preencha o registro da aeronave...", true);
        return;
      }

      if (!anoValido()) {
        showStatusMessage("Ano deve de 1990 até 2026...", true);
        return;
      }

      if (!totalAssentosValido()) {
        showStatusMessage("Preencha corretamente o total de assentos.", true);
        return;
      }

      // se chegou até aqui a execução do código, vamos alterar a aeronave. 
      // obtendo os dados: 
      const fabricante = document.getElementById("editFabricantes").value;
      const modelo = document.getElementById("editModelo").value;
      const anoFab = document.getElementById("editAnoFab").value;
      const referencia = document.getElementById("editReferencia").value;
      const totalAssentos = document.getElementById("editTotalAssentos").value;

      // ESTUDAR O CONCEITO DE PROMISES.
      fetchInserir({
        fabricante: fabricante,
        modelo: modelo,
        totalAssentos: totalAssentos,
        anoFabricacao: anoFab,
        referencia: referencia
      })
        .then(customResponse => {
          // obteve resposta, vamos simplesmente exibir como mensagem: 
          if (customResponse.status === "SUCCESS") showStatusMessage("Aeronave alterarda... ", false);
          else {
            showStatusMessage("Erro ao alterar aeronave...: " + customResponse.message, true);
            console.log(customResponse.message);
          }
        })
        .catch((e) => {
          showStatusMessage("Erro técnico ao alterar... Contate o suporte.\n" + e, true);
          console.log("Falha grave ao alterar." + e)
        });
    }

    function salvarAlteracao() {
      // Obtenha os dados da aeronave ada
      const codigo = document.getElementById("codigoAeronave").value;
      const fabricante = document.getElementById("fabricante").value;
      const modelo = document.getElementById("modelo").value;
      const anoFab = document.getElementById("anoFab").value;
      const referencia = document.getElementById("referencia").value;
      const totalAssentos = document.getElementById("totalAssentos").value;

      // Valide os campos da aeronave se necessário

      // Construa um objeto com os dados da aeronave a ser atualizada
      const aeronaveData = {
        codigo: codigo,
        fabricante: fabricante,
        modelo: modelo,
        anoFabricacao: anoFab,
        referencia: referencia,
        totalAssentos: totalAssentos,
      };

      // Envie a solicitação de alteração para o servidor
      requestAlterarAeronave(aeronaveData)
        .then((customResponse) => {
          if (customResponse.status === "SUCCESS") {
            showStatusMessage("Aeronave alterada com sucesso.", false);
            document.getElementById("edit-aeronave").style.display = "none";
            document.getElementById("dados-aeronave").style.display = "block";
            // Atualize a tabela aqui com os novos valores, se necessário
          } else {
            showStatusMessage("Erro ao alterar aeronave: " + customResponse.message, true);
            console.log(customResponse.message);
          }
        })
        .catch((e) => {
          showStatusMessage("Erro técnico ao alterar aeronave. Entre em contato com o suporte.", true);
          console.log("Falha grave ao alterar aeronave: " + e);
        });
    }

    function excluirAeronave(c) {
      console.log('Clicou no excluir aeronave: ' + c);
      // vamos fazer a exclusão
      requestExcluirAeronave({ codigo: c })
        .then(customResponse => {
          // obteve resposta na exclusão, chamamos novamente o carregar.
          if (customResponse.status === "SUCCESS") {
            location.reload();
          } else {
            // tratar corretamente o erro... (melhorar...)
            console.log(customResponse.message);
          }
        })
        .catch((e) => {
          console.log("Não foi possível excluir." + e);
        });
    }

    function exibirAeronaves() {
      console.log('Entrou no exibir...')
      requestListaDeAeronaves()
        .then(customResponse => {
          // obteve resposta, vamos simplesmente exibir como mensagem:
          if (customResponse.status === "SUCCESS") {
            // vamos obter o que está no payload e chamar a função .
            console.log("Deu certo a busca de aeronaves");
            // agora chamar a função de exibição dos dados em tabela... 
            // no payload voltou o Array com as aeronaves. 
            // DEVEMOS antes, conferir se o ARRAY não está vazio. Faça essa mudança.
            console.log('Payload:' + JSON.stringify(customResponse.payload));
            preencherTabela(JSON.parse(JSON.stringify(customResponse.payload)))
          } else {
            // tratar corretamente o erro... (melhorar...)
            console.log(customResponse.message);
          }
        })
        .catch((e) => {
          // FAZER O TRATAMENTO...
          console.log("Não foi possível exibir." + e);
        });
    }

    function requestExcluirAeronave(body) {
      const requestOptions = {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      };
      return fetch('http://localhost:3000/excluirAeronave', requestOptions)
        .then(T => T.json())
    }

    function requestAlterarAeronave(body) {
      const requestOptions = {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      };
      return fetch('http://localhost:3000/alterarAeronave', requestOptions)
        .then(T => T.json())
    }

    function requestListaDeAeronaves() {
      const requestOptions = {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' },
      };
      return fetch('http://localhost:3000/listarAeronaves', requestOptions)
        .then(T => T.json())
    }

    function preencherTabela(aeronaves) {

      // acessando a referencia pelo id do tbody
      const tblBody = document.getElementById("dados-aeronave");

      let aeronave = "";
      // creating all cells
      for (let i = 0; i < aeronaves.length; i++) {

        aeronave = aeronaves[i];
        console.log("Dados da aeronave: " + aeronave);
        // row representa a linha da tabela (um novo tr)
        const row = document.createElement("tr");

        row.innerHTML =
          `
            <td class="leftText">${aeronave.codigo}</td>
            <td class="leftText">${aeronave.fabricante}</td>
            <td class="leftText">${aeronave.modelo}</td>
            <td class="centerText">${aeronave.referencia}</td>
            <td class="rightText">${aeronave.anoFabricacao}</td>
            <td class="rightText">${aeronave.totalAssentos}</td>
            <td class="centerText">
              <img
                src="/front/src/assets/images/delete_icon.png"
                width="45"
                onclick="excluirAeronave(${aeronave.codigo});"
                style="margin-right: 25px;"
              />
              <img
                src="/front/src/assets/images/edit_icon.png"
                width="40"
                onclick="alterarAeronave(${aeronave.codigo});"
              />
            </td>
            `

        // adicionando a linha que representa a aeronave. 
        tblBody.appendChild(row);
      }
    }

    function showStatusMessage(msg, error) {
      var pStatus = document.getElementById("status");
      if (error === true) pStatus.className = "statusError";
      else pStatus.className = "statusSuccess";

      pStatus.textContent = msg;
    }

  </script>
</head>

<body data-bs-theme="dark">
  <h1>Aeronaves</h1>
  <hr />
  <table id="tblAeronaves" cellspacing="5" cellpadding="10" class="table table-striped">
    <thead>
      <tr>
        <th width="5%" class="leftText">Código</th>
        <th width="10%" class="leftText">Fabricante</th>
        <th width="20%" class="leftText">Modelo</th>
        <th width="10%" class="centerText">Referência</th>
        <th width="10%" class="rightText">Ano Fab.</th>
        <th width="10%" class="rightText">Qtde de Assentos</th>
        <th width="10%" class="centerText">Opções</th>
      </tr>
    </thead>
    <tbody id="dados-aeronave"></tbody>
  </table>

  <div id="edit-aeronave" style="display: none;">
    <input type="text" id="editCodigoAeronave" />
    <input type="text" id="editFabricante" />
    <input type="text" id="editModelo" />
    <input type="text" id="editAnoFab" />
    <input type="text" id="editReferencia" />
    <input type="text" id="editTotalAssentos" />
    <button onclick="salvarAlteracao()">Salvar</button>
  </div>

  <div>
    <p id="status" class="statusError"></p>
    <p>
      <button type="button" class="button" onclick="window.history.back();" id="btnSair" name="btnSair">Sair</button>
    </p>
  </div>
  <script>

    // vamos chamar a função aqui no final para carregar as aeronaves depois
    // que renderizar toda a página HTML.
    exibirAeronaves();
  </script>
</body>

</html>